// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PHARMACIST
  PHARMACY_TECHNICIAN
  INVENTORY_MANAGER
  AUDITOR
  VIEWER
}

enum DrugCategory {
  ANTIBIOTIC
  ANALGESIC
  ANTIFUNGAL
  ANTIHISTAMINE
  ANTIMALARIAL
  CARDIOVASCULAR
  RESPIRATORY
  GASTROINTESTINAL
  ENDOCRINE
  NEUROLOGICAL
  ONCOLOGY
  VITAMIN_SUPPLEMENT
  VACCINE
  ANTIHYPERTENSIVE // For blood pressure medications
  ANTIDIABETIC // For diabetes medications
  ANTICOAGULANT // Blood thinners
  ANTIDEPRESSANT // Mental health
  ANTIPSYCHOTIC // Mental health
  ANXIOLYTIC // Anti-anxiety
  SEDATIVE // Sleep aids
  MUSCLE_RELAXANT // Muscle pain
  DERMATOLOGICAL // Skin conditions
  OPHTHALMIC // Eye medications
  OTIC // Ear medications
  CONTRACEPTIVE // Birth control
  HORMONE_THERAPY // Hormonal treatments
  IMMUNOSUPPRESSANT // Immune system
  ANTIEMETIC // Nausea/vomiting
  LAXATIVE // Digestive
  ANTACID // Acid reflux
  DIURETIC // Fluid retention
  BRONCHODILATOR // Breathing/asthma
  ANTIVIRAL // Viral infections
  ANTIPARASITIC // Parasites
  CHEMOTHERAPY // Cancer treatment
  OTHER
}

enum DrugForm {
  TABLET
  CAPSULE
  SYRUP
  INJECTION
  CREAM
  OINTMENT
  DROPS
  INHALER
  PATCH
  SUPPOSITORY
  POWDER
  SUSPENSION
  SOLUTION
}

enum PrescriptionRequired {
  YES
  NO
  CONTROLLED_SUBSTANCE
}

enum StorageCondition {
  ROOM_TEMPERATURE
  REFRIGERATED
  FROZEN
  CONTROLLED_TEMPERATURE
  PROTECT_FROM_LIGHT
  PROTECT_FROM_MOISTURE
}

enum StockStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  OVERSTOCKED
  DISCONTINUED
}

enum TransactionType {
  PURCHASE
  SALE
  RETURN
  ADJUSTMENT
  TRANSFER
  DISPOSAL
  DAMAGE
  EXPIRY
}

enum OrderStatus {
  PENDING
  APPROVED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REJECTED
}

enum AuditStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  DISCREPANCY_FOUND
}

// ============================================
// MODELS
// ============================================

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  firstName String
  lastName  String
  role      UserRole  @default(VIEWER)
  phone     String?
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  drugs        Drug[]
  transactions Transaction[]
  orders       Order[]
  audits       Audit[]
  alerts       Alert[]

  @@index([email])
  @@index([role])
}

model Drug {
  id                   String               @id @default(cuid())
  name                 String
  genericName          String
  brandName            String?
  category             DrugCategory
  form                 DrugForm
  strength             String // e.g., "500mg", "10ml"
  manufacturer         String
  description          String?
  activeIngredient     String
  prescriptionRequired PrescriptionRequired
  barcode              String?              @unique
  sku                  String?              @unique
  storageCondition     StorageCondition
  minimumStockLevel    Int                  @default(10)
  reorderLevel         Int                  @default(50)
  isActive             Boolean              @default(true)
  userId               String
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  // Relations
  batches      Batch[]
  transactions Transaction[]
  orderItems   OrderItem[]
  suppliers    SupplierDrug[]
  alerts       Alert[]

  @@index([name])
  @@index([genericName])
  @@index([category])
  @@index([barcode])
  @@index([sku])
  @@index([userId])
}

model Batch {
  id                String      @id @default(cuid())
  batchNumber       String      @unique
  drugId            String
  quantityReceived  Int
  quantityAvailable Int
  quantityReserved  Int         @default(0)
  unitPrice         Decimal     @db.Decimal(10, 2)
  sellingPrice      Decimal     @db.Decimal(10, 2)
  manufactureDate   DateTime
  expiryDate        DateTime
  receivedDate      DateTime    @default(now())
  supplierId        String
  locationId        String
  status            StockStatus @default(IN_STOCK)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  drug         Drug          @relation(fields: [drugId], references: [id], onDelete: Cascade)
  supplier     Supplier      @relation(fields: [supplierId], references: [id])
  location     Location      @relation(fields: [locationId], references: [id])
  transactions Transaction[]

  @@index([drugId])
  @@index([batchNumber])
  @@index([expiryDate])
  @@index([status])
}

model Supplier {
  id            String   @id @default(cuid())
  name          String
  contactPerson String
  email         String   @unique
  phone         String
  address       String
  city          String
  state         String?
  country       String
  postalCode    String?
  taxId         String?
  paymentTerms  String?
  isActive      Boolean  @default(true)
  rating        Decimal? @db.Decimal(3, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  batches Batch[]
  orders  Order[]
  drugs   SupplierDrug[]

  @@index([name])
  @@index([email])
}

model SupplierDrug {
  id           String   @id @default(cuid())
  supplierId   String
  drugId       String
  supplierSku  String?
  unitPrice    Decimal  @db.Decimal(10, 2)
  minimumOrder Int      @default(1)
  leadTimeDays Int      @default(7)
  isPreferred  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  drug     Drug     @relation(fields: [drugId], references: [id], onDelete: Cascade)

  @@unique([supplierId, drugId])
  @@index([drugId])
}

model Location {
  id          String   @id @default(cuid())
  name        String
  type        String // e.g., "Main Warehouse", "Pharmacy", "Storage Room"
  building    String?
  floor       String?
  section     String?
  aisle       String?
  shelf       String?
  capacity    Int?
  temperature Decimal? @db.Decimal(5, 2)
  humidity    Decimal? @db.Decimal(5, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  batches Batch[]

  @@index([name])
}

model Transaction {
  id              String          @id @default(cuid())
  type            TransactionType
  drugId          String
  batchId         String?
  quantity        Int
  unitPrice       Decimal         @db.Decimal(10, 2)
  totalPrice      Decimal         @db.Decimal(10, 2)
  userId          String
  customerId      String?
  referenceNumber String?
  notes           String?
  transactionDate DateTime        @default(now())
  createdAt       DateTime        @default(now())

  // Relations
  drug     Drug      @relation(fields: [drugId], references: [id])
  batch    Batch?    @relation(fields: [batchId], references: [id])
  user     User      @relation(fields: [userId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([drugId])
  @@index([type])
  @@index([transactionDate])
  @@index([userId])
}

model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique
  supplierId   String
  userId       String
  status       OrderStatus @default(PENDING)
  orderDate    DateTime    @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  totalAmount  Decimal     @db.Decimal(10, 2)
  shippingCost Decimal?    @db.Decimal(10, 2)
  tax          Decimal?    @db.Decimal(10, 2)
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  supplier Supplier    @relation(fields: [supplierId], references: [id])
  user     User        @relation(fields: [userId], references: [id])
  items    OrderItem[]

  @@index([orderNumber])
  @@index([status])
  @@index([orderDate])
}

model OrderItem {
  id               String   @id @default(cuid())
  orderId          String
  drugId           String
  quantity         Int
  unitPrice        Decimal  @db.Decimal(10, 2)
  totalPrice       Decimal  @db.Decimal(10, 2)
  receivedQuantity Int?
  createdAt        DateTime @default(now())

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  drug  Drug  @relation(fields: [drugId], references: [id])

  @@index([orderId])
  @@index([drugId])
}

model Customer {
  id                 String    @id @default(cuid())
  firstName          String
  lastName           String
  email              String?   @unique
  phone              String
  dateOfBirth        DateTime?
  address            String?
  city               String?
  state              String?
  postalCode         String?
  allergies          String?
  prescriptionNumber String?
  insuranceInfo      String?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  transactions Transaction[]

  @@index([phone])
  @@index([email])
}

model Audit {
  id            String      @id @default(cuid())
  auditNumber   String      @unique
  userId        String
  status        AuditStatus @default(SCHEDULED)
  scheduledDate DateTime
  startDate     DateTime?
  completedDate DateTime?
  discrepancies Json?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([scheduledDate])
}

model Alert {
  id         String    @id @default(cuid())
  type       String // e.g., "LOW_STOCK", "EXPIRY_WARNING", "REORDER_POINT"
  severity   String // e.g., "INFO", "WARNING", "CRITICAL"
  message    String
  drugId     String?
  userId     String?
  isRead     Boolean   @default(false)
  isResolved Boolean   @default(false)
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  // Relations
  drug Drug? @relation(fields: [drugId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([isRead])
  @@index([isResolved])
  @@index([createdAt])
}
